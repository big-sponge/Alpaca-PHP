<html>
<head>
    <link href="/webCJI/css/timing.css" rel="stylesheet" type="text/css" />
    <link href="/webCJI/css/jquery.datetimepicker.css" rel="stylesheet" type="text/css"/>
    <script src="/webCJI/js/jquery-2.1.4.min.js" type="text/javascript"></script>
    <script src="/webCJI/js/jquery.datetimepicker.js" type="text/javascript"></script>
    <script src="/webCJI/dotjs/dot.js" type="text/javascript"></script>    
</head>
<body>
<script id="cronTabCell" type="text/x-dot-template">
    <table class="time_tab m_time_tab">
        <tr class="list_log">
            <td>任务名称</td>
            <td>类型</td>
            <td>间隔</td>
            <td>开始时间</td>
            <td>结束时间</td>
            <td>执行任务</td>
            <td>状态</td>
            <td>删除</td>
        </tr>
        {{ for(var key in it) { }}
        <tr class="list_con">
            <td>{{=it[key].NAME}}</td>
            <td>{{=it[key].TYPE}}</td>
            <td>{{=it[key].INTERVAL}}</td>
            <td>{{=it[key].BEGIN_TIME}}</td>
            <td>{{=it[key].NEXT_TIME}}</td>
            <td>{{=it[key].LAST_TIME}}</td>
            <td>
                <label class="label_switch">
                    <input type="checkbox" class="chooser">
                    <div class="checkbox"></div>
                </label>
            </td>
            <td class="delete">删除</td>
        </tr>
        {{ } }}
    </table>
</script>
<div class="time_title">
    <div class="time_title_box">
        <img src="/webCJI/img/logo.png" class="logo">
        <div class="time_title_btn">
            <button id="id_time_btn" class="time_btn">创建任务</button>
            <button id="id_time_btn" class="time_btn time_btn_samll" style="background-color:#4fca72;">开始</button>
            <button id="id_time_btn" class="time_btn time_btn_samll" style="background-color:#de5f5f;">停止</button>
        </div>
    </div>
</div>
<div class="time_content">
    <div class="time_list">
        <div class="time_margin" id="cronTabList">

        </div>
    </div>
    <!--弹出框-->
    <div id="id_alert" class="alert_cont" style="margin-left:-300px; margin-top:-200px;">
        <div class="alert_title">
            <div class="title_word"></div>
            <div class="close"><img src="/webCJI/img/btn_close_layer.png" class="close_btn" /></div>
        </div>
        <div class="detail">
            <div class="oder_details">
                <div class="oder_details_main_list">
                    <div class="m_label">名字：</div>
                    <div class="m_word">
                        <input class="choose input" type="text" id="name"/>
                    </div>
                </div>
                <div class="oder_details_main_list">
                    <div class="m_label">类型：</div>
                    <div class="m_word">
                        <select class="choose" id="cronTabType" onchange="changeType()">
                            <option value="1">执行一次</option>
                            <option value="2">循环执行</option>
                        </select>
                    </div>
                </div>
                <div class="oder_details_main_list" id="intervalDiv">
                    <div class="m_label">时间间隔：</div>
                    <div class="m_word">
                        <input class="choose" id="interval">
                    </div>
                </div>
                <div class="oder_details_main_list">
                    <div class="m_label">开始时间：</div>
                    <div class="m_word">
                        <input class="choose" type="text" id="startTime" />
                    </div>
                </div>
                <div class="oder_details_main_list" id="endTimeDiv">
                    <div class="m_label">结束时间：</div>
                    <div class="m_word">
                        <input class="choose" type="text" id="endTime" />
                    </div>
                </div>
                <div class="alert_btn_box">
                    <button class="sure_btn" id="id_sure_btn">确定</button>
                    <button class="close">取消</button>
                </div>
            </div>
        </div>
    </div>
    <div class="alert_body" id="mask"></div>
</div>
<script>
    $('#startTime').datetimepicker();  //日期插件
    $("endTime").datetimepicker();
</script>
<script>
    $(".close").click(function(){
        $("#id_alert").fadeOut();
        $("#mask").hide();
    });
    $(".list_con").click(function(){
        $("#mask").show();
        $(".title_word").html("修改任务")
        $("#id_alert").fadeIn();
        $(".list_con").css({"background-color":"#fff","color":"#666"});
        $(this).css({"background-color":"#43a5ff","color":"#fff"});

    });
    $("#id_time_btn").click(function(){
        $("#mask").show();
        $(".title_word").html("创建任务")
        $("#id_alert").fadeIn();
    });
    $("#id_sure_btn").click(function(){
        addTask();
    });

    function changeType(){
        if($("#cronTabType").val() == "1"){
            $("#intervalDiv").css("display", "none");
            $("#endTimeDiv").css("display", "none");
        }
        else {
            $("#intervalDiv").css("display", "block");
            $("#endTimeDiv").css("display", "block");
        }
    }

    $().ready(function () {
        loadTaskList();
    });

    function loadTaskList(){
        $.ajax({
            method: "POST",
            url: "/crontab/index/listtask",
            data:"",
            timeout: 20000,
            beforeSend: function () {
            },
            success: function (data) {
                var cronTabCellText = doT.template($("#cronTabCell").text());
                $("#cronTabList").html(cronTabCellText(data));
                console.log(data);

                //按钮开关事件
                $(".chooser").change(function(){
                    console.log($(this)[0].checked);
                    if($(this)[0].checked){
                        $(this).next(".checkbox").addClass("bg_checkbox change move ");
                    }else{
                        $(this).next(".checkbox").removeClass("bg_checkbox change move ");
                    }
                });
            },
            complete: function () {
            },
            error: function () {
                alert("请求出错了,请稍候再试");
            }
        });


    }

    function addTask(){
        var json={
            "NAME":"task",
            "STATUS":"1",
            "TYPE":"2",
            "INTERVAL":"+10 second",//秒为单位
            "BEGIN_TIME":"2016-06-29 17:00:00",
            "NEXT_TIME":"",
            "LAST_TIME":"",
            "ACTION":"/crontab/index/job"
        };
        $.ajax({
            method: "POST",
            url: "/crontab/index/addtask",
            data:JSON.stringify(json),
            timeout: 20000,
            beforeSend: function () {
            },
            success: function (data) {
                var code = data.result_code;
                var msg = data.result_message;
                if(code == 1){
                    $("#id_alert").fadeOut();
                    $("#mask").hide();
                    //刷新task列表
                    loadTaskList();
                }else{
                    alert(msg);
                }
            },
            complete: function () {
            },
            error: function () {
                alert("请求出错了,请稍候再试");
            }
        });
    }

    function deleteTask(){
        var json={
            "NAME":"task",
            "STATUS":"1",
            "TYPE":"2",
            "INTERVAL":"+10 second",//秒为单位
            "BEGIN_TIME":"2016-06-29 17:00:00",
            "NEXT_TIME":"",
            "LAST_TIME":"",
            "ACTION":"/crontab/index/job"
        };
        $.ajax({
            method: "POST",
            url: "/crontab/index/addtask",
            data:JSON.stringify(json),
            timeout: 20000,
            beforeSend: function () {
            },
            success: function (data) {
                var code = data.result_code;
                var msg = data.result_message;
                if(code == 1){
                    $("#id_alert").fadeOut();
                    $("#mask").hide();
                    //刷新task列表
                    loadTaskList();
                }else{
                    alert(msg);
                }
            },
            complete: function () {
            },
            error: function () {
                alert("请求出错了,请稍候再试");
            }
        });
    }

    
</script>
</body>
</html>